<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Purgatory</title>
    <!-- These script tags load the engines from the internet -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/7.4.2/pixi.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi-dragonbones@5.6.5/dist/pixi-dragonbones.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@pixi/filter-glow@5.2.0/dist/pixi-filters.js"></script>
    <!-- Icon library -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>
    <style>
        body, html { 
            margin: 0; 
            padding: 0; 
            background-color: #1a202c; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; 
            height: 100vh;
            overflow: hidden;
        }
        
        .game-container { 
            display: flex; 
            width: 100vw; 
            height: 100vh; 
        }
        
        .left-panel { 
            flex-grow: 1; 
            display: flex; 
            flex-direction: column; 
            padding: 1rem; 
            min-width: 0;
        }
        
        .world-view { 
            flex-grow: 1; 
            background-color: #000; 
            border-radius: 0.5rem; 
            overflow: hidden; 
            cursor: pointer; 
            position: relative;
        }
        
        .world-view-wrapper {
            flex-grow: 1;
            display: flex;
            flex-direction: column;
        }
        
        #world-canvas-container {
            flex-grow: 1;
            background-color: #000;
            border-radius: 0.5rem;
            overflow: hidden;
            cursor: pointer;
        }
        
        .interaction-log-container { 
            background-color: #2d3748; 
            margin-top: 1rem; 
            border-radius: 0.5rem; 
            padding: 1rem; 
        }
        
        .chat-container {
            background-color: #2d3748;
            margin-top: 1rem;
            border-radius: 0.5rem;
            padding: 1rem;
        }
        
        .interaction-log { 
            height: 150px; 
            overflow-y: auto; 
            margin-bottom: 0.5rem; 
        }
        
        #chat-log {
            height: 150px;
            overflow-y: auto;
            margin-bottom: 0.5rem;
            color: white;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .right-panel { 
            width: 320px; 
            background-color: #2d3748; 
            padding: 1rem; 
            color: white; 
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .widget {
            background-color: #4a5568;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        
        .character-portrait-widget {
            background-color: #4a5568;
            padding: 1rem;
            border-radius: 0.5rem;
        }
        
        .stat-bar-container {
            background-color: #2d3748;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
        }
        
        .stat-bar-fill {
            height: 100%;
            transition: width 0.3s ease;
        }
        
        .tabs {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        
        .tab-link {
            background-color: #2d3748;
            color: #a0aec0;
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.25rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: all 0.2s;
            flex: 1;
            text-align: center;
        }
        
        .tab-link:hover {
            background-color: #4a5568;
            color: white;
        }
        
        .tab-link.active {
            background-color: #3182ce;
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .options-button {
            margin-top: auto;
            background-color: white;
            color: #4a5568;
            border: 1px solid #e2e8f0;
            padding: 0.75rem;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: background-color 0.2s;
        }
        
        .options-button:hover {
            background-color: #f7fafc;
        }
        
        /* Start screen styles */
        .start-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        
        .start-container {
            text-align: center;
            background: rgba(255, 255, 255, 0.95);
            padding: 3rem 2rem;
            border-radius: 1rem;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 90%;
        }
        
        .game-title {
            font-size: 3rem;
            font-weight: bold;
            color: #333;
            margin-bottom: 0.5rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .game-subtitle {
            font-size: 1.2rem;
            color: #666;
            margin-bottom: 2rem;
        }
        
        .start-button {
            background: linear-gradient(45deg, #4CAF50, #45a049);
            color: white;
            border: none;
            padding: 1rem 2.5rem;
            font-size: 1.2rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(76, 175, 80, 0.4);
        }
        
        .start-button:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(76, 175, 80, 0.6);
        }
        
        .start-button:disabled {
            background: #ccc;
            cursor: not-allowed;
            box-shadow: none;
            opacity: 0.6;
        }
        
        /* Modal styles */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
        }
        
        .modal-backdrop.hidden {
            display: none;
        }
        
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 1rem;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        
        /* Character Creator Modal Styles */
        #character-creator-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .creator-modal-content {
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            width: 100%;
            max-width: 1200px;
            max-height: 90vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .creator-header {
            padding: 20px 30px;
            border-bottom: 2px solid #eee;
            background: #f8f9fa;
        }

        .creator-header h2 {
            margin: 0;
            color: #333;
            font-size: 1.8rem;
        }

        .creator-body {
            flex: 1;
            overflow-y: auto;
            padding: 20px 30px;
        }

        .creator-footer {
            padding: 20px 30px;
            border-top: 2px solid #eee;
            background: #f8f9fa;
        }

        /* Character Tabs */
        #character-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding-bottom: 5px;
        }

        .creator-tab {
            padding: 12px 20px;
            background: #e9ecef;
            border: none;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.2s ease;
            white-space: nowrap;
            min-width: 120px;
        }

        .creator-tab:hover {
            background: #dee2e6;
        }

        .creator-tab.active {
            background: #007bff;
            color: white;
        }

        .creator-tab.player-character {
            border: 2px solid #ffc107;
            font-weight: bold;
        }

        /* Character Panels */
        #character-panels {
            min-height: 500px;
            position: relative;
        }

        .creator-panel {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .creator-panel.hidden {
            display: none;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Utility classes */
        .hidden { display: none !important; }
        .flex { display: flex; }
        .items-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 0.75rem; }
        .gap-4 { gap: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-4 { margin-bottom: 1rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-6 { margin-top: 1.5rem; }
        .p-2 { padding: 0.5rem; }
        .text-xs { font-size: 0.75rem; }
        .text-sm { font-size: 0.875rem; }
        .text-xl { font-size: 1.25rem; }
        .text-2xl { font-size: 1.5rem; }
        .font-bold { font-weight: bold; }
        .font-semibold { font-weight: 600; }
        .font-mono { font-family: monospace; }
        .w-full { width: 100%; }
        .h-2 { height: 0.5rem; }
        .rounded-full { border-radius: 9999px; }
        .rounded-md { border-radius: 0.375rem; }
        .border { border-width: 1px; }
        .border-gray-300 { border-color: #d1d5db; }
        .bg-gray-200 { background-color: #e5e7eb; }
        .bg-white { background-color: white; }
        .text-gray-700 { color: #374151; }
        .text-gray-800 { color: #1f2937; }
        .text-blue-600 { color: #2563eb; }
        .text-green-500 { color: #10b981; }
        .text-orange-500 { color: #f97316; }
        .text-sky-500 { color: #0ea5e9; }
        .text-red-500 { color: #ef4444; }
        .text-slate-500 { color: #64748b; }
        .bg-green-500 { background-color: #10b981; }
        .bg-orange-500 { background-color: #f97316; }
        .bg-sky-500 { background-color: #0ea5e9; }
        .bg-red-500 { background-color: #ef4444; }
        .space-y-2 > * + * { margin-top: 0.5rem; }
        .space-y-3 > * + * { margin-top: 0.75rem; }
        .flex-grow { flex-grow: 1; }
        .flex-shrink-0 { flex-shrink: 0; }
        .overflow-hidden { overflow: hidden; }
        .outline-none { outline: none; }
        .shadow-lg { box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .border-4 { border-width: 4px; }
        .border-white { border-color: white; }
        .w-[80px] { width: 80px; }
        .h-[80px] { height: 80px; }
        .overflow-y-auto { overflow-y: auto; }
    </style>
</head>
<body>
    <!-- Start Screen -->
    <div id="start-screen" class="start-screen">
        <div class="start-container">
            <h1 class="game-title">🏢 Office Purgatory</h1>
            <p class="game-subtitle">A workplace simulation where AI characters live their digital lives</p>
            <button id="new-game-btn" class="start-button" disabled>
                Loading...
            </button>
            <p id="loading-status" class="mt-6 text-sm text-gray-500">Initializing game systems...</p>
        </div>
    </div>

    <!-- BILO_FIX: New modal for office type selection -->
    <div id="office-type-modal-backdrop" class="modal-backdrop hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-4">Select Your Office</h2>
            <p class="text-gray-600 mb-6">Choose an office type to determine the available jobs for your team.</p>
            <div class="form-group mb-6">
                <label for="office-type-select" class="sr-only">Office Type</label>
                <select id="office-type-select" class="w-full p-3 border border-gray-300 rounded-md">
                    <option value="Default">Default Office</option>
                    <option value="Startup">Startup Hub</option>
                    <option value="Corp">Corporate Headquarters</option>
                </select>
            </div>
            <button id="select-office-button" class="start-button w-full">Continue</button>
        </div>
    </div>

    <!-- Character Creator Modal -->
    <div id="character-creator-modal">
        <div class="creator-modal-content">
            <!-- Header with Office Type Selector -->
            <div class="creator-header">
                <h2>👥 Character Creator</h2>
                <p style="margin: 10px 0 0 0; color: #666;">Create your office team and start the simulation</p>
                <!-- Office type selector will be inserted here by the UI module -->
            </div>

            <!-- Body -->
            <div class="creator-body">
                <!-- Global API Key Section -->
                <div id="global-api-section">
                    <!-- Will be populated by UI module -->
                </div>

                <!-- Character Management Controls -->
                <div id="character-controls">
                    <!-- Will be populated by UI module -->
                </div>

                <!-- Character Tabs -->
                <div id="character-tabs">
                    <!-- Character tabs will be inserted here -->
                </div>

                <!-- Character Panels -->
                <div id="character-panels">
                    <!-- Character panels will be inserted here -->
                </div>
            </div>

            <!-- Footer -->
            <div class="creator-footer">
                <div style="text-align: center;">
                    <button type="button" id="start-simulation-btn" 
                            style="padding: 15px 40px; background: #4caf50; color: white; border: none; border-radius: 8px; font-weight: 600; font-size: 18px; cursor: pointer; box-shadow: 0 4px 8px rgba(76, 175, 80, 0.3);">
                        🚀 Start Simulation
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- OLD CHARACTER CREATOR MODAL (kept for compatibility during transition) -->
    <div id="creator-modal-backdrop" class="modal-backdrop hidden">
        <div id="creator-modal-content">
            <div class="creator-header"><h1 class="text-2xl font-bold">Create Your Team</h1></div>
            <div class="creator-main">
                <div class="creator-tabs" id="character-tabs"></div>
                <div class="creator-panel-container" id="character-panels"></div>
            </div>
            <div class="creator-footer">
                <button id="randomize-btn" class="action-button bg-gray-500">Randomize All</button>
                <button id="start-simulation-button" class="action-button">Start Simulation</button>
            </div>
        </div>
    </div>

    <!-- Main Game UI -->
    <div id="main-game-ui" class="game-container hidden">
        <div class="left-panel">
            <div class="world-view-wrapper"><div id="world-canvas-container"></div></div>
            <div id="chat-system" class="chat-container">
                <div id="chat-log"></div>
                <div class="chat-input-group flex">
                    <select id="input-mode-selector" class="bg-gray-200 border border-gray-300 rounded-l-md p-2 text-gray-700">
                        <option value="talk">Talk</option>
                        <option value="action">Action</option>
                    </select>
                    <input type="text" id="player-input" class="flex-grow bg-white border-t border-b border-gray-300 p-2 outline-none text-gray-800" placeholder="Type a command or message...">
                </div>
            </div>
        </div>
        <div class="right-panel">
            <div class="widget character-portrait-widget flex items-center gap-4">
                <div class="w-[80px] h-[80px] rounded-full border-4 border-white shadow-lg overflow-hidden flex-shrink-0">
                    <canvas id="player-portrait-canvas" width="48" height="48" class="w-full h-full"></canvas>
                </div>
                <div class="flex-grow">
                    <h2 id="character-name" class="text-xl font-bold">Bilo</h2>
                    <p id="character-role" class="text-sm text-slate-500">Senior Coder</p>
                    <div id="clock-display" class="text-xs text-blue-600 font-mono mt-2">--:--:--</div>
                </div>
            </div>
            <div class="widget">
                <h3 class="font-bold mb-4 text-lg">Character Status</h3>
                <div class="space-y-3">
                    <div class="flex items-center gap-3"><i class="ph-fill ph-battery-high text-green-500 text-xl"></i><div class="w-full"><div class="flex justify-between mb-1 text-xs font-semibold"><span>Energy</span><span id="energy-value">0%</span></div><div class="stat-bar-container bg-gray-200 rounded-full h-2"><div id="energy-bar" class="stat-bar-fill bg-green-500 h-2 rounded-full" style="width: 0%;"></div></div></div></div>
                    <div class="flex items-center gap-3"><i class="ph-fill ph-hamburger text-orange-500 text-xl"></i><div class="w-full"><div class="flex justify-between mb-1 text-xs font-semibold"><span>Hunger</span><span id="hunger-value">0%</span></div><div class="stat-bar-container bg-gray-200 rounded-full h-2"><div id="hunger-bar" class="stat-bar-fill bg-orange-500 h-2 rounded-full" style="width: 0%;"></div></div></div></div>
                    <div class="flex items-center gap-3"><i class="ph-fill ph-chats-circle text-sky-500 text-xl"></i><div class="w-full"><div class="flex justify-between mb-1 text-xs font-semibold"><span>Social</span><span id="social-value">0%</span></div><div class="stat-bar-container bg-gray-200 rounded-full h-2"><div id="social-bar" class="stat-bar-fill bg-sky-500 h-2 rounded-full" style="width: 0%;"></div></div></div></div>
                    <div class="flex items-center gap-3"><i class="ph-fill ph-fire text-red-500 text-xl"></i><div class="w-full"><div class="flex justify-between mb-1 text-xs font-semibold"><span>Stress</span><span id="stress-value">0%</span></div><div class="stat-bar-container bg-gray-200 rounded-full h-2"><div id="stress-bar" class="stat-bar-fill bg-red-500 h-2 rounded-full" style="width: 0%;"></div></div></div></div>
                </div>
            </div>
            <div class="widget flex-grow flex flex-col">
                <div class="tabs flex items-center gap-2 mb-2">
                    <button class="tab-link active" onclick="openTab(event, 'inventory')">Inventory</button>
                    <button class="tab-link" onclick="openTab(event, 'tasks')">Tasks</button>
                    <button class="tab-link" onclick="openTab(event, 'relationships')">Relationships</button>
                </div>
                <div class="flex-grow overflow-y-auto">
                    <div id="inventory" class="tab-content active"><ul id="inventory-list" class="space-y-2 text-sm"></ul></div>
                    <div id="tasks" class="tab-content"><div id="task-content"></div></div>
                    <div id="relationships" class="tab-content"><ul id="relationships-list" class="space-y-3"></ul></div>
                </div>
            </div>
            <button class="options-button bg-white border border-gray-300 text-gray-700 rounded-md p-2 w-full flex items-center justify-center gap-2 hover:bg-gray-50"><i class="ph ph-gear-wide-connected"></i> Options</button>
        </div>
    </div>
    
    <script>
        // BILO_FIX: This function handles switching between tabs in the status panel.
        function openTab(evt, tabName) {
            var i, tabcontent, tablinks;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.remove("active");
            }
            tablinks = document.getElementsByClassName("tab-link");
            for (i = 0; i < tablinks.length; i++) {
                tablinks[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
    </script>
    <script type="module" src="main.js"></script>
</body>
</html>
